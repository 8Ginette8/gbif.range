name: R-Package-Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  check-and-version:
    if: "!contains(github.event.head_commit.message, 'chore: update version')"
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libudunits2-dev libgdal-dev libgeos-dev libproj-dev texlive-latex-extra texinfo ghostscript

      - name: Install R packages
        run: |
          Rscript -e '
            pkgs <- c("devtools", "remotes", "terra", "sf", "rgbif", "CoordinateCleaner", "ClusterR", "FNN", "geometry", "cluster", "rnaturalearth", "mclust", "methods", "utils", "zip", "class", "NMOF")
            missing <- setdiff(pkgs, rownames(installed.packages()))
            if (length(missing) > 0) install.packages(missing, repos = "https://cloud.r-project.org")
          '

      - name: Check package
        run: |
          R CMD build . --no-manual
          R CMD check *.tar.gz --no-manual --as-cran

      - name: Auto Version and Tag
        if: "github.event_name == 'push' && github.ref == 'refs/heads/main'"
        run: |
          Rscript -e '
            # 1. Get last tag safely
            all_tags <- system("git tag", intern=TRUE)
            tag <- if(length(all_tags) > 0) system("git describe --tags --abbrev=0", intern=TRUE) else "v0.0.0"
            
            # 2. Calculate impact
            diff <- system(paste0("git diff --shortstat ", tag, "..HEAD"), intern=TRUE)
            impact <- if(length(diff) > 0) sum(as.numeric(unlist(regmatches(diff, gregexpr("[0-9]+", diff))))[-1], na.rm=TRUE) else 0
            
            # 3. Logic
            desc <- read.dcf("DESCRIPTION")
            curr_v <- numeric_version(desc[,"Version"])
            files <- system(paste0("git diff --name-only ", tag, "..HEAD"), intern=TRUE)
            
            if (impact > 5000) { v <- paste(curr_v$major + 1, 0, 0, sep=".")
            } else if (impact > 300 || any(grepl("NAMESPACE", files))) { v <- paste(curr_v$major, curr_v$minor + 1, 0, sep=".")
            } else { v <- paste(curr_v$major, curr_v$minor, curr_v$patch + 1, sep=".") }
            
            # 4. Write back
            desc[,"Version"] <- v
            write.dcf(desc, "DESCRIPTION")
            writeLines(v, "ver.txt")
            message(paste("Calculated version:", v))
          '
          # Use the temp file to set the variable
          NEW_V=$(cat ver.txt)
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git add DESCRIPTION
          git commit -m "chore: update version to $NEW_V [skip ci]"
          git tag v$NEW_V
          git push origin main --tags