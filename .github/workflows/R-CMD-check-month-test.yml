name: R-Package-Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  check-and-version:
    # Prevents the pipeline from running on its own version-update commits
    if: "!contains(github.event.head_commit.message, 'chore: update version')"
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Crucial: Downloads tags so R can see v0.5.0

      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - name: Auto Version and Tag
        if: "github.event_name == 'push' && github.ref == 'refs/heads/main'"
        run: |
          Rscript -e '
            # 1. Get Baseline and Impact
            tags <- system("git tag --sort=-v:refname", intern=TRUE)
            tag <- if(length(tags) > 0) tags[1] else "v1.1.0"
            diff_out <- system(paste0("git diff --shortstat ", tag, "..HEAD"), intern=TRUE)
            impact <- 0
            if(length(diff_out) > 0) {
              nums <- as.numeric(unlist(regmatches(diff_out, gregexpr("[0-9]+", diff_out))))
              if(length(nums) > 1) impact <- sum(nums[-1], na.rm=TRUE)
            }

            # 2. Calculate Total Lines in R/ directory
            # We focus on the R/ folder because that is the "heart" of your package
            all_r_files <- list.files("R", pattern = "\\.[Rr]$|\\.[Rr]md$", full.names = TRUE, recursive = TRUE)
            total_lines <- sum(sapply(all_r_files, function(f) length(readLines(f))))
            
            # 3. Calculate Percentage Change
            # Avoid division by zero if package is empty
            perc <- if(total_lines > 0) (impact / total_lines) * 100 else 0
            
            # 4. Read DESCRIPTION
            lines <- readLines("DESCRIPTION")
            v_idx <- grep("^Version:", lines)
            v_str <- gsub("Version:\\s*", "", lines[v_idx])
            v_parts <- as.numeric(unlist(strsplit(v_str, "\\.")))
            maj <- v_parts[1]; min <- v_parts[2]; pat <- v_parts[3]

            # 5. Percentage-Based Logic
            # Major: > 40% change (Massive rewrite)
            # Minor: > 5% change (Significant new feature/change)
            # Patch: < 5% change (Maintenance)
            if (perc > 40) {
              maj <- maj + 1; min <- 0; pat <- 0
            } else if (perc > 5) {
              min <- min + 1; pat <- 0
            } else {
              pat <- pat + 1
            }

            new_v <- paste(maj, min, pat, sep=".")
            lines[v_idx] <- paste0("Version: ", new_v)
            writeLines(lines, "DESCRIPTION")
            writeLines(new_v, "ver.txt")
            
            cat(sprintf("Total LOC: %d | Impact: %d | Change: %.2f%%\n", total_lines, impact, perc))
            cat(sprintf("Result: %s -> %s\n", v_str, new_v))
          '