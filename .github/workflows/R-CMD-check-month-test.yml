- name: Auto Version and Tag
        if: "github.event_name == 'push' && github.ref == 'refs/heads/main'"
        run: |
          Rscript -e '
            # 1. Find tags
            all_tags <- system("git tag", intern=TRUE)
            valid_tags <- all_tags[grepl("^v[0-9]", all_tags)]
            
            # Use v0.5.0 as default if no tags found
            tag <- if(length(valid_tags) > 0) tail(sort(valid_tags), 1) else ""
            
            # 2. Calculate impact
            impact <- 0
            if (tag != "") {
              diff_out <- system(paste0("git diff --shortstat ", tag, "..HEAD"), intern=TRUE)
              if (length(diff_out) > 0) {
                nums <- as.numeric(unlist(regmatches(diff_out, gregexpr("[0-9]+", diff_out))))
                impact <- sum(nums[-1], na.rm=TRUE)
              }
            }
            
            # 3. Read DESCRIPTION
            desc <- read.dcf("DESCRIPTION")
            # Fallback to 0.5.0 if Version is missing/weird
            raw_v <- if("Version" %in% colnames(desc)) desc[1,"Version"] else "0.5.0"
            curr_v <- numeric_version(raw_v)
            
            # 4. Versioning Logic with Safety
            maj <- curr_v$major
            min <- curr_v$minor
            pat <- curr_v$patch
            
            if (impact > 5000) { 
              maj <- maj + 1; min <- 0; pat <- 0
            } else if (impact > 300) { 
              min <- min + 1; pat <- 0
            } else { 
              pat <- pat + 1 
            }
            
            new_v <- paste(maj, min, pat, sep=".")
            
            # FINAL SAFETY: Ensure we don't have 0.0
            if(new_v == "0.0.0" || new_v == "0.0") new_v <- "1.0.0"
            
            # 5. Write
            desc[1,"Version"] <- new_v
            write.dcf(desc, "DESCRIPTION", keep.white = colnames(desc))
            writeLines(as.character(new_v), "ver.txt")
            message(paste("Impact:", impact, "| New Version:", new_v))
          '
          NEW_V=$(cat ver.txt)
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git add DESCRIPTION
          git commit -m "chore: update version to $NEW_V [skip ci]"
          git tag v$NEW_V
          git push origin main --tags