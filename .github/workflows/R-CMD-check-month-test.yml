name: R-Package-Auto-Version

on:
  push:
    branches: [main]

jobs:
  auto-version:
    if: "!contains(github.event.head_commit.message, 'chore: update version')"
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - name: Auto bump version and tag
        run: |
          git fetch --tags --force

          # Exit if no code changes since last commit (prevents empty bumps)
          git diff --quiet HEAD~1 || true

          Rscript -e '
            # ---- 1. Latest tag ----
            tags <- system("git tag --sort=-v:refname", intern=TRUE)
            tag <- if (length(tags)) tags[1] else "v0.0.0"

            # ---- 2. Diff impact ----
            diff_out <- system(paste0("git diff -w --shortstat ", tag, "..HEAD"), intern=TRUE)
            impact <- 0
            if (length(diff_out)) {
              nums <- as.numeric(unlist(regmatches(diff_out, gregexpr("[0-9]+", diff_out))))
              if (length(nums) > 1) impact <- sum(nums[-1], na.rm=TRUE)
            }

            # ---- 3. Total code lines ----
            files <- list.files("R", pattern="\\.[Rr]$|\\.[Rr]md$", recursive=TRUE, full.names=TRUE)
            total <- sum(sapply(files, function(f) length(readLines(f, warn=FALSE))))
            pct <- if (total > 0) (impact / total) * 100 else 0

            # ---- 4. Parse version ----
            v <- as.numeric(strsplit(sub("^v","", tag), "\\.")[[1]])
            maj <- v[1]; min <- v[2]; pat <- v[3]

            # ---- 5. Bump logic ----
            if (pct > 40) {
              maj <- maj + 1; min <- 0; pat <- 0
            } else if (pct > 5) {
              min <- min + 1; pat <- 0
            } else {
              pat <- pat + 1
            }

            new_v <- paste(maj, min, pat, sep=".")

            # ---- 6. Write ----
            d <- readLines("DESCRIPTION")
            d[grep("^Version:", d)] <- paste0("Version: ", new_v)
            writeLines(d, "DESCRIPTION")
            writeLines(new_v, "ver.txt")

            cat(sprintf("Baseline: %s | Impact: %d | Percent: %.2f%% | New: %s\n",
                        tag, impact, pct, new_v))
          '

          NEW_V=$(cat ver.txt)

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add DESCRIPTION
          git commit -m "chore: update version to $NEW_V [skip ci]"

          git tag v$NEW_V
          git push origin main
          git push origin v$NEW_V
