name: R-Package-CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  auto-version:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && !contains(github.event.head_commit.message, 'chore: release')
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - name: Auto bump version + tag
        run: |
          git fetch --tags --force
          Rscript -e '
            tags <- system("git tag --sort=-v:refname", intern=TRUE)
            tag <- if (length(tags)) tags[1] else "v0.0.0"

            diff_files <- system(paste0("git diff --name-only ", tag, "..HEAD"), intern=TRUE)
            code_files <- diff_files[grepl("^R/|^src/|^inst/", diff_files)]

            if (length(code_files) == 0) {
              cat("NO_CHANGE\n")
              quit(status = 0)
            }

            diff_out <- system(paste0("git diff -w --shortstat ", tag, "..HEAD"), intern=TRUE)
            impact <- 0
            if (length(diff_out)) {
              nums <- as.numeric(unlist(regmatches(diff_out, gregexpr("[0-9]+", diff_out))))
              if (length(nums) > 1) impact <- sum(nums[-1], na.rm=TRUE)
            }

            files <- list.files(c("R","src","inst"), pattern="\\.[Rr]$|\\.c$|\\.cpp$", recursive=TRUE, full.names=TRUE)
            total <- sum(sapply(files, function(f) length(readLines(f, warn=FALSE))))
            pct <- if (total > 0) (impact / total) * 100 else 0

            v <- as.numeric(strsplit(sub
